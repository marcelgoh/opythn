(* OPythn main front-end *)

open Printf

(* print tokens generated by lexer *)
let print_lex buffer =
  let tok = ref (Lexer.read buffer) in
  while !tok <> EOF do
    printf "%s" (Token.show !tok);
    tok := (Lexer.read buffer)
  done;
  printf "%s" (Token.show !tok)

(* return printable AST generated by parser *)
let parse buffer = try Parser.input Lexer.read buffer with
                     Parser.Error ->
                       printf "%s: Syntax error.\n" (Lexer.print_position buffer); []

(* run tests *)
let run_tests opy_code =
  let buffer = ref (Lexing.from_string opy_code) in
  printf "************ LEXER OUTPUT ************\n";
  Lexer.setup_file_input !buffer;
  print_lex !buffer;
  printf "************ PARSER OUTPUT ************\n";
  buffer := Lexing.from_string opy_code; (* reset buffer *)
  Lexer.setup_file_input !buffer;
  let tree = parse !buffer in
  printf "%s\n" (Ast.show tree);
  printf "************ BYTECODE ************\n";
  let instrs = Bytecode.compile_prog tree in
  Bytecode.print_asm instrs;
  printf "************ CONSOLE OUTPUT ************\n";
  Interpreter.interpret instrs @@ Interpreter.init_env ()

(* quit repl *)
let quit _ =
  printf "\nIch sterbe.\n";
  exit 0

(* read-eval-print loop *)
let rec repl envr =
  printf "]=> ";
  flush stdout;
  let buffer = Lexing.from_channel stdin in
  Lexer.setup_repl_input buffer;
  let tree = parse buffer in
  printf "************ PARSER OUTPUT ************\n";
  printf "%s\n" (Ast.show tree);
  printf "************ BYTECODE ************\n";
  let instrs = Bytecode.compile_prog tree in
  Bytecode.print_asm instrs;
  printf "************ CONSOLE OUTPUT ************\n";
  Interpreter.interpret instrs envr;
  repl envr

let rec debug () =
  printf "DEBUG]=> ";
  flush stdout;
  let buffer = Lexing.from_channel stdin in
  Lexer.setup_repl_input buffer;
  printf "************ LEXER OUTPUT ************\n";
  print_lex buffer;
  debug ()

(* select mode based on program arguments *)
let main () =
  Sys.set_signal Sys.sigint (Sys.Signal_handle quit);
  if Array.length Sys.argv < 2 then (
    (* start interactive mode *)
    printf "+----------------------------------------------+\n";
    printf "|             OPYTHN INTERACTIVE MODE          |\n";
    printf "|   Author: Marcel Goh (Release: 20.04.2019)   |\n";
    printf "|            Type \"Ctrl-C\" to quit.            |\n";
    printf "+----------------------------------------------+\n";
    flush stdout;
    let envr = Interpreter.init_env () in
    repl envr
  )
  else
    if Sys.argv.(1) = "-debug" then (
      printf "Entering debug mode.\n" ; debug()
    )
    else
      (* interpret from file *)
      match Fileio.str_of_prog_args () with
        Some s -> run_tests s
      | None   -> printf "Failed to read from file.\n"

let () = main ()
